name: Release Native + PyPI

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "v0.3.2"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}

jobs:
  native:
    name: Build native (${{ matrix.os }})
    if: >
      (github.event_name == 'push' && startsWith(github.ref_name, 'v')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag, 'v'))
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ env.TAG }}

      - name: Configure (CMake Release)
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Test
        run: ctest --test-dir build -C Release --output-on-failure

      - name: Package native (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp -f include/ballistic_solver_c_api.h dist/

          if [[ "${RUNNER_OS}" == "Linux" ]]; then
            libpath="$(find build -maxdepth 10 -type f -name "libballistic_solver.so" -print -quit)"
          else
            libpath="$(find build -maxdepth 10 -type f -name "libballistic_solver.dylib" -print -quit)"
          fi

          if [[ -z "${libpath:-}" ]]; then
            echo "ERROR: shared library not found under build/"
            exit 1
          fi

          cp -f "$libpath" dist/
          os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          (cd dist && zip -r "../ballistic_solver_${TAG}_${os}.zip" .)

      - name: Package native (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          Copy-Item -Force include\ballistic_solver_c_api.h dist\

          $dll = Get-ChildItem -Path build -Recurse -Filter ballistic_solver.dll -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $dll)
          {
            Write-Error "ERROR: ballistic_solver.dll not found under build/"
            exit 1
          }

          Copy-Item -Force $dll.FullName dist\
          Compress-Archive -Path dist\* -DestinationPath "ballistic_solver_$($env:TAG)_windows.zip" -Force

      - uses: actions/upload-artifact@v4
        with:
          name: native-${{ runner.os }}
          path: ballistic_solver_*.zip

  py_wheels:
    name: Build python wheels (${{ matrix.os }})
    if: >
      (github.event_name == 'push' && startsWith(github.ref_name, 'v')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag, 'v'))
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ env.TAG }}

      - name: Build wheels (cibuildwheel)
        uses: pypa/cibuildwheel@v3.3.1
        with:
          package-dir: bindings/python
          output-dir: wheelhouse
        env:
          CIBW_BUILD: "cp310-* cp311-* cp312-*"
          CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_*"
          CIBW_ARCHS_MACOS: "universal2"
          CIBW_BUILD_VERBOSITY: "3"
          CIBW_TEST_COMMAND: >-
            python -c "import ballistic_solver; from ballistic_solver import ArcMode; print(ArcMode.Low)"

      - uses: actions/upload-artifact@v4
        with:
          name: pywheels-${{ runner.os }}
          path: wheelhouse/*.whl
          if-no-files-found: error

  sdist:
    name: Build python sdist
    if: >
      (github.event_name == 'push' && startsWith(github.ref_name, 'v')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag, 'v'))
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ env.TAG }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build sdist
        working-directory: bindings/python
        run: |
          python -m pip install -U pip build
          python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: pysdist
          path: bindings/python/dist/*.tar.gz
          if-no-files-found: error

  publish:
    name: Publish (PyPI + GitHub Release assets)
    needs: [native, py_wheels, sdist]
    if: >
      (github.event_name == 'push' && startsWith(github.ref_name, 'v')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag, 'v'))
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Collect PyPI dist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find artifacts -type f \( -name "*.whl" -o -name "*.tar.gz" \) -exec cp {} dist/ \;
          ls -la dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

      - name: Create release if missing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if gh release view "${TAG}" > /dev/null 2>&1; then
            echo "Release ${TAG} already exists."
          else
            gh release create "${TAG}" --title "${TAG}" --generate-notes
          fi

      - name: Upload assets to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${TAG}" artifacts/*.zip --clobber
          gh release upload "${TAG}" dist/* --clobber
